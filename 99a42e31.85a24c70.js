(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{101:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return o})),a.d(t,"metadata",(function(){return r})),a.d(t,"toc",(function(){return i})),a.d(t,"default",(function(){return b}));var n=a(3),c=a(7),s=(a(0),a(120)),o={id:"buildtransactions",title:"Assemble Transactions"},r={unversionedId:"tutorials/buildtransactions",id:"tutorials/buildtransactions",isDocsHomePage:!1,title:"Assemble Transactions",description:"The goal and core functionality of a DApp built on top of Lumos is to build transactions in response to user requests. Lumos provides the TransactionSkeleton interface that significantly simplifies the transaction assembling process. Each transaction skeleton corresponds to an action, and will be built into a single transaction that is ready to be submitted to CKB.",source:"@site/docs\\tutorials\\buildtransactions.md",slug:"/tutorials/buildtransactions",permalink:"/lumos_doc/docs/tutorials/buildtransactions",editUrl:"https://github.com/xying21/lumos_doc/tree/master/docs/tutorials/buildtransactions.md",version:"current",sidebar:"someSidebar",previous:{title:"Query on Transactions",permalink:"/lumos_doc/docs/tutorials/querytransactions"},next:{title:"Manage Accounts",permalink:"/lumos_doc/docs/tutorials/manageaccounts"}},i=[{value:"General Workflow",id:"general-workflow",children:[]},{value:"Examples",id:"examples",children:[{value:"Transfer CKB in a Common Transaction",id:"transfer-ckb-in-a-common-transaction",children:[]},{value:"Deposit CKB to DAO",id:"deposit-ckb-to-dao",children:[]},{value:"List DAO Cells",id:"list-dao-cells",children:[]},{value:"Withdraw a Cell from Nervos DAO",id:"withdraw-a-cell-from-nervos-dao",children:[]},{value:"Unlock a Withdrawn Cell",id:"unlock-a-withdrawn-cell",children:[]},{value:"Transfer CKB with locktimepool",id:"transfer-ckb-with-locktimepool",children:[]}]}],l={toc:i};function b(e){var t=e.components,a=Object(c.a)(e,["components"]);return Object(s.b)("wrapper",Object(n.a)({},l,a,{components:t,mdxType:"MDXLayout"}),Object(s.b)("p",null,"The goal and core functionality of a DApp built on top of Lumos is to build transactions in response to user requests. Lumos provides the ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/develop/packages/helpers/src/index.ts#L212"}),"TransactionSkeleton")," interface that significantly simplifies the transaction assembling process. Each transaction skeleton corresponds to an action, and will be built into a single transaction that is ready to be submitted to CKB."),Object(s.b)("p",null,"This guide introduces the general workflow of assembling transactions. The workflow applies to the following examples of a common transfer operation, DAO deposit and withdraw operations, and a transfer operation with the ",Object(s.b)("inlineCode",{parentName:"p"},"locktimepool"),"."),Object(s.b)("h2",{id:"general-workflow"},"General Workflow"),Object(s.b)("ol",null,Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},Object(s.b)("strong",{parentName:"p"},"The DApp creates a transaction skeleton"),".")),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},Object(s.b)("strong",{parentName:"p"},"The DApp adds the fee for the transaction"),". The sender or someone other than the sender can pay the fee. ")),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},Object(s.b)("strong",{parentName:"p"},"The DApp prepares the signing entries"),". The signing entries are the data that the user's wallet needs to sign to provide valid witnesses for the input lock scripts. ")),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},Object(s.b)("strong",{parentName:"p"},"The DApp acquires the signature from a user wallet"),"."),Object(s.b)("div",Object(n.a)({parentName:"li"},{className:"admonition admonition-note alert alert--secondary"}),Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-heading"}),Object(s.b)("h5",{parentName:"div"},Object(s.b)("span",Object(n.a)({parentName:"h5"},{className:"admonition-icon"}),Object(s.b)("svg",Object(n.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(s.b)("path",Object(n.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-content"}),Object(s.b)("p",{parentName:"div"},"From the security perspective of a DApp, Lumos does not support built-in message signing. So the DApp needs to send the raw transaction "," to the user wallet to acquire signatures. The raw transaction contains all the cells and dependencies for the action and the data that needs to be signed."," ")))),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},Object(s.b)("strong",{parentName:"p"},"The DApp seals the transaction.")," The transaction with signatures is forwarded to the DApp. The DApp seals the transaction by adding the transaction signatures to the transaction structure. ")),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},Object(s.b)("strong",{parentName:"p"},"The DApp forwards this finalized transaction to the CKB network"),". The DApp forwards the sealed transaction to the CKB network through the RPC interface. Upon successful receipt, the CKB network returns the transaction hash to the DApp. The transaction hash is sent back to the client such that the client can track the transactions.")),Object(s.b)("li",{parentName:"ol"},Object(s.b)("p",{parentName:"li"},Object(s.b)("strong",{parentName:"p"},"(Optional) The DApp gets the transaction status.")))),Object(s.b)("h2",{id:"examples"},"Examples"),Object(s.b)("h3",{id:"transfer-ckb-in-a-common-transaction"},"Transfer CKB in a Common Transaction"),Object(s.b)("p",null,"The @ckb-lumos/common-scripts package includes a ",Object(s.b)("inlineCode",{parentName:"p"},"common")," script that can transfer capacity from ",Object(s.b)("inlineCode",{parentName:"p"},"fromInfos")," to an address. "),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"Step 1. Create a transaction skeleton.")),Object(s.b)("p",null,"Example:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-typescript",metastring:'title="hellolumos/src/buildTXs.ts/commonTransfer()" {4}',title:'"hellolumos/src/buildTXs.ts/commonTransfer()"',"{4}":!0}),"let txSkeleton:TransactionSkeletonType = TransactionSkeleton({cellProvider: INDEXER});\nconst tipheader = await rpc.get_tip_header();\n\ntxSkeleton = await common.transfer(\n            txSkeleton,\n            fromInfos,\n            toAddress,\n            BigInt(amount),\n            undefined,\n            tipheader\n            );\n")),Object(s.b)("p",null,"The example creates a transaction skeleton with the ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/c3bd18e6baac9c283995f25d226a689970dc9537/packages/common-scripts/src/common.ts#L175",title:"(txSkeleton: TransactionSkeletonType, fromInfos: FromInfo[], toAddress: string, amount: bigint, changeAddress?: string | undefined, tipHeader?: Header | undefined, { config, useLocktimeCellsFirst</var>, <var>LocktimePoolCellCollector</var>, }?)"}),"common.transfer")," function."),Object(s.b)("p",null,"The ",Object(s.b)("var",null,"fromInfos")," parameter used for generating signing messages can be a ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/c3bd18e6baac9c283995f25d226a689970dc9537/packages/common-scripts/src/from_info.ts#L20"}),"MultisigScript")," | Address (string) | ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/c3bd18e6baac9c283995f25d226a689970dc9537/packages/common-scripts/src/from_info.ts#L31"}),"ACP")," | ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/c3bd18e6baac9c283995f25d226a689970dc9537/packages/common-scripts/src/from_info.ts#L36"}),"CustomScript"),". MultisigScript is used for the secp256k1_blake160_multisig lock script (the transactions that require multi-signatures)."),Object(s.b)("p",null,"An example of fromInfos including MultisigScript:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{}),'const fromInfos = [\n  "ckb1qyqwyxfa75whssgkq9ukkdd30d8c7txct0gq5f9mxs",\n  {\n    R: 0,\n    M: 1,\n    publicKeyHashes: ["0x36c329ed630d6ce750712a477543672adab57f4c"],\n  },\n]\n')),Object(s.b)("p",null," If ",Object(s.b)("var",null,"changeAddress")," is not specified, the first element of ",Object(s.b)("var",null,"fromInfos")," is used as the change address. "),Object(s.b)("p",null,"The ",Object(s.b)("inlineCode",{parentName:"p"},"common.transfer")," function can use cells with lock period in priority over other cells by specifying ",Object(s.b)("var",null,"tipHeader")," in the transfer function."),Object(s.b)("p",null,"To use the cells without lock period, just use ",Object(s.b)("inlineCode",{parentName:"p"},"undefined")," for ",Object(s.b)("var",null,"tipHeader")," or specify the ",Object(s.b)("var",null,"useLocktimeCellsFirst")," parameter as false."),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"Step 2. Add the fee for the transaction.")),Object(s.b)("p",null,"Example:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-typescript",metastring:'title="hellolumos/src/buildTXs.ts/commonTransfer()"',title:'"hellolumos/src/buildTXs.ts/commonTransfer()"'}),"txSkeleton = await common.payFee(\n        txSkeleton,\n        fromInfos,\n        BigInt(txFee),\n)\n")),Object(s.b)("p",null,"The ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/c3bd18e6baac9c283995f25d226a689970dc9537/packages/common-scripts/src/common.ts#L412"}),"common.payFee")," function is used to add the transaction fee to the transaction skeleton."),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"Step 3. Prepare the signing entries.")," "),Object(s.b)("p",null,"Example:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-typescript",metastring:'title="hellolumos/src/buildTXs.ts/commonTransfer()"',title:'"hellolumos/src/buildTXs.ts/commonTransfer()"'}),"skeleton = common.prepareSigningEntries(txSkeleton);\n")),Object(s.b)("p",null,"The ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/c3bd18e6baac9c283995f25d226a689970dc9537/packages/common-scripts/src/common.ts#L434"}),"common.prepareSigningEntries")," function is used to add the signing entries to the transaction skeleton. The result is a raw transaction that requires signatures."),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"Step 4. Sign and seal the transaction.")),Object(s.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-heading"}),Object(s.b)("h5",{parentName:"div"},Object(s.b)("span",Object(n.a)({parentName:"h5"},{className:"admonition-icon"}),Object(s.b)("svg",Object(n.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(s.b)("path",Object(n.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-content"}),Object(s.b)("p",{parentName:"div"},"Lumos does not support built-in message signing. The DApp needs to send the raw transaction to the user wallet to acquire signatures. "))),Object(s.b)("p",null,"For simplicity and demonstration, this example uses the ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/c3bd18e6baac9c283995f25d226a689970dc9537/packages/hd/src/key.ts#L7"}),"key.signRecoverable")," function of the HD wallet manager (@ckb-lumos/hd) package to generate a signature based on the private key of the account. "),Object(s.b)("p",null,"Example:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-typescript",metastring:'title="hellolumos/src/buildTXs.ts/signandSeal()" {9,10}',title:'"hellolumos/src/buildTXs.ts/signandSeal()"',"{9,10}":!0}),'import {key} from "@ckb-lumos/hd";\nimport { sealTransaction } from "@ckb-lumos/helpers";\n\nexport async function signandSeal(\n    txskeleton:TransactionSkeletonType,\n    privatekey : string\n):Promise<Transaction>{\n    const message = txskeleton.get("signingEntries").get(0)?.message;\n    const Sig = key.signRecoverable(message!, privatekey);\n    const tx = sealTransaction(txskeleton, [Sig]);\n    return tx;\n}\n')),Object(s.b)("p",null,"The following is a signature output example\uff1a"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell"}),"[  \n'0x4f73f26e51bee76d89edb74aee20e6fb2f8c670881f087aba04be80d7bd05117579d2bcfea3618d55473504e06586c10eecb76169d2ef0849c72e50a2f5d2b9500'\n]\n")),Object(s.b)("p",null,"To seal the transaction, the example uses the ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/c3bd18e6baac9c283995f25d226a689970dc9537/packages/helpers/src/index.ts#L257"}),"sealTransaction")," function of the @ckb-lumos/helpers package to add the transaction signatures to the transaction skeleton."),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"Step 5. Send this finalized transaction to the CKB network.")),Object(s.b)("p",null,"Example:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-typescript",metastring:'title="hellolumos/src/buildTXs.ts/commonTransfer()" {3}',title:'"hellolumos/src/buildTXs.ts/commonTransfer()"',"{3}":!0}),'import { RPC } from "@ckb-lumos/rpc";\nconst rpc = new RPC("http://127.0.0.1:8114");\nconst hash = await rpc.send_transaction(tx);\nconsole.log("The transaction hash is",hash);\n')),Object(s.b)("p",null,"The ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/c3bd18e6baac9c283995f25d226a689970dc9537/packages/rpc/src/index.ts#L339"}),"send_transaction")," function of the @ckb-lumos/rpc package is used to send the transaction. The function sends the transaction to chain and returns a hash for the transaction. The hash can then be used to track the transactions."),Object(s.b)("p",null,"The following is a transaction hash output example:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell"}),"The transaction hash is 0x10104ec6857fd99b818e7b401216268c067ce7fbc536b77c86f3565c108e958e\n")),Object(s.b)("div",{className:"admonition admonition-info alert alert--info"},Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-heading"}),Object(s.b)("h5",{parentName:"div"},Object(s.b)("span",Object(n.a)({parentName:"h5"},{className:"admonition-icon"}),Object(s.b)("svg",Object(n.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(s.b)("path",Object(n.a)({parentName:"svg"},{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})))),"info")),Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-content"}),Object(s.b)("p",{parentName:"div"},"The earlier versions before 0.16.0 require the Anyone-Can-Pay (ACP) script for submitting transactions. If you fail to submit transactions because of missing the ACP script, you can upgrade Lumos to the latest version, or copy a dummy script into the config.json file under the root of the DApp project to fix the error."))),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"Step 6. (Optional) Get the Transaction Status.")),Object(s.b)("p",null,"Example:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-typescript"}),'const txWithStatus= await rpc.get_transaction(hash);\nconsole.log("Transaction status is:",txWithStatus.tx_status.status); \n')),Object(s.b)("h3",{id:"deposit-ckb-to-dao"},"Deposit CKB to DAO"),Object(s.b)("p",null,"Nervos DAO is a smart contract. Users can interact the same way as any smart contract on CKB with Nervos DAO. One function of Nervos DAO is to provide an dilution counter-measure for CKByte holders. By deposit in Nervos DAO, holders get proportional secondary rewards, which guarantee their holding are only affected by hardcapped primary issuance as in Bitcoin. For more information about Nervos DAO, see ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/rfcs/blob/master/rfcs/0023-dao-deposit-withdraw/0023-dao-deposit-withdraw.md"}),"RFC: Nervos DAO"),"."),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"Step 1. Create a transaction skeleton with the DAO script.")),Object(s.b)("p",null,"Example:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-typescript",metastring:'title="hellolumos/src/buildTXs.ts/deposit2DAO()" {3}',title:'"hellolumos/src/buildTXs.ts/deposit2DAO()"',"{3}":!0}),'let skeleton:TransactionSkeletonType = TransactionSkeleton({cellProvider: INDEXER});\nconsole.log("Deposit to DAO transaction");\nskeleton = await dao.deposit(skeleton,sender,sender,BigInt(amount));\n')),Object(s.b)("p",null,"The example creates a transaction skeleton for the deposit action with the cells provided by the indexer. "),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"Constructor")),Object(s.b)("p",null,Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/c3bd18e6baac9c283995f25d226a689970dc9537/packages/common-scripts/src/dao.ts#L112"}),"dao.deposit"),"(",Object(s.b)("var",null,"txSkeleton"),", ",Object(s.b)("var",null,"fromInfo"),", ",Object(s.b)("var",null,"toAddress"),", ",Object(s.b)("var",null,"amount"),", { ",Object(s.b)("var",null,"config")," }?)"),Object(s.b)("p",null,"The ",Object(s.b)("var",null,"fromInfo")," parameter must be specified when it is a ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/c3bd18e6baac9c283995f25d226a689970dc9537/packages/common-scripts/src/from_info.ts#L20"}),"MultisigScript")," script."),Object(s.b)("p",null,"The same address is used as the ",Object(s.b)("inlineCode",{parentName:"p"},"fromInfo")," and ",Object(s.b)("inlineCode",{parentName:"p"},"toAddress")," in the ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/c3bd18e6baac9c283995f25d226a689970dc9537/packages/common-scripts/src/dao.ts#L112"}),"deposit")," function. The deposited cells are frozen after the deposit operation."),Object(s.b)("p",null,"Use the ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/c3bd18e6baac9c283995f25d226a689970dc9537/packages/helpers/src/index.ts#L224"}),"createTransactionFromSkeleton")," function to view the current skeleton. "),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-typescript",metastring:'title="hellolumos/src/buildTXs.ts/deposit2DAO()"',title:'"hellolumos/src/buildTXs.ts/deposit2DAO()"'}),'import { createTransactionFromSkeleton } from "@ckb-lumos/helpers";\nconsole.log(JSON.stringify(createTransactionFromSkeleton(skeleton), null, 2));\n')),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"Step 2. Add the fee for the deposit transaction.")),Object(s.b)("p",null,"Example:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-typescript",metastring:'title="hellolumos/src/buildTXs.ts/deposit2DAO()"',title:'"hellolumos/src/buildTXs.ts/deposit2DAO()"'}),"skeleton = await secp256k1Blake160.payFee(skeleton,sender,BigInt(txFee));\n")),Object(s.b)("p",null,"The example uses an existing module, the secp256k1-blake160 lock script of the @ckb-lumos/common-scripts package to build the transaction for the paying transaction fee action. "),Object(s.b)("p",null,"The deposit action and the paying transaction fee action are using the same address (the sender address). If you checked the transaction skeleton after incurring fees, you can notice that the transaction skeleton has only one input for the two actions. Lumos can intelligently rewrite the change cells generated in the deposit action to pay enough transaction fee. "),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"Step 3. Prepare the signing entries.")," "),Object(s.b)("p",null,"Example:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-typescript",metastring:'title="hellolumos/src/buildTXs.ts/deposit2DAO()"',title:'"hellolumos/src/buildTXs.ts/deposit2DAO()"'}),"skeleton = secp256k1Blake160.prepareSigningEntries(skeleton);\n")),Object(s.b)("p",null,"This example loops through the skeleton, and creates ",Object(s.b)("inlineCode",{parentName:"p"},"signingEntries")," by using the default secp256k1-blake160 lock script."),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"Step 4. Sign and seal the transaction.")),Object(s.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-heading"}),Object(s.b)("h5",{parentName:"div"},Object(s.b)("span",Object(n.a)({parentName:"h5"},{className:"admonition-icon"}),Object(s.b)("svg",Object(n.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(s.b)("path",Object(n.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-content"}),Object(s.b)("p",{parentName:"div"},"Lumos does not support built-in message signing. The DApp needs to send the raw transaction to the user wallet to acquire signatures. "))),Object(s.b)("p",null,"For simplicity and demonstration, the example uses the ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/c3bd18e6baac9c283995f25d226a689970dc9537/packages/hd/src/key.ts#L7"}),"key.signRecoverable")," function of the HD wallet manager (@ckb-lumos/hd) to generate a signature based on the private key of the account. "),Object(s.b)("p",null,"For more information, see Step 4 in the common transaction section."),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"Step 5. Send this finalized transaction to the CKB network")),Object(s.b)("p",null,"Example:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-typescript",metastring:'title="hellolumos/src/buildTXs.ts/deposit2DAO()"',title:'"hellolumos/src/buildTXs.ts/deposit2DAO()"'}),' const hash = await rpc.send_transaction(tx);\n console.log("The transaction hash is",hash);\n return hash;\n')),Object(s.b)("p",null,"The following is a deposit transaction hash output example:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell"}),"The transaction hash is 0x655bac89e443db42d48644f9fd89ddee70691f8e39ee4635c313375e8b2e6c0a\n")),Object(s.b)("p",null,"Try the ",Object(s.b)("inlineCode",{parentName:"p"},"deposit2DAO")," function in the Node.js REPL mode:"),Object(s.b)("details",null,Object(s.b)("summary",null,"CLICK ME"),Object(s.b)("p",null,Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell"}),'$ cd hellolumos\n$ node --experimental-repl-await\nWelcome to Node.js v14.0.0.\nType ".help" for more information.\n> const {accounts,buildTXs} = require(".");\nThe server is started.\n> const alice = accounts.ALICE;\n> await buildTXs.deposit2DAO(alice.ADDRESS,20000000000n,10000000n,alice.PRIVATE_KEY);\nDeposit to DAO transaction\n{\n  "version": "0x0",\n  "cell_deps": [\n    {\n      "out_point": {\n        "tx_hash": "0xa563884b3686078ec7e7677a5f86449b15cf2693f3c1241766c6996f206cc541",\n        "index": "0x2"\n      },\n      "dep_type": "code"\n    },\n    {\n      "out_point": {\n        "tx_hash": "0xace5ea83c478bb866edf122ff862085789158f5cbff155b7bb5f13058555b708",\n        "index": "0x0"\n      },\n      "dep_type": "dep_group"\n    }\n  ],\n  "header_deps": [],\n  "inputs": [\n    {\n      "since": "0x0",\n      "previous_output": {\n        "tx_hash": "0xd1b20dd4042374ad44d8ef9489420ff9d09cb6e72767fa549926ca42deced13a",\n        "index": "0x0"\n      }\n    }\n  ],\n  "outputs": [\n    {\n      "capacity": "0x4a817c800",\n      "lock": {\n        "code_hash": "0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8",\n        "hash_type": "type",\n        "args": "0x7e00660b8ab122bca3ba468c5b6eee71f40b7d8e"\n      },\n      "type": {\n        "code_hash": "0x82d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e",\n        "hash_type": "type",\n        "args": "0x"\n      }\n    },\n    {\n      "capacity": "0x1242f69cc698",\n      "lock": {\n        "code_hash": "0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8",\n        "hash_type": "type",\n        "args": "0x7e00660b8ab122bca3ba468c5b6eee71f40b7d8e"\n      }\n    }\n  ],\n  "outputs_data": [\n    "0x0000000000000000",\n    "0x"\n  ],\n  "witnesses": [\n    "0x55000000100000005500000055000000410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"\n  ]\n}\n1\nsigningEntries: [\n  {\n    type: \'witness_args_lock\',\n    index: 0,\n    message: \'0x9728a156408f43f8d8de4fe48e3d14f16b1fc3086eaa419ae435f83b08dc6dfa\'\n  }\n]\nThe transaction hash is 0x58f49e100a00742396fa66bcd2541fadcae549b56e75350efaa166d5d5bfacdc\n\'0x58f49e100a00742396fa66bcd2541fadcae549b56e75350efaa166d5d5bfacdc\'\n')))),Object(s.b)("p",null,"When the transaction is committed to the chain, check the capacity by using ckb-cli. You can see the deposited 200 CKB in the result."),Object(s.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-heading"}),Object(s.b)("h5",{parentName:"div"},Object(s.b)("span",Object(n.a)({parentName:"h5"},{className:"admonition-icon"}),Object(s.b)("svg",Object(n.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(s.b)("path",Object(n.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-content"}),Object(s.b)("p",{parentName:"div"},"Ensure the CKB minder is started to enable the transaction to be committed."))),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell"}),'$ ckb-cli wallet get-capacity --address "ckt1qyq8uqrxpw9tzg4u5waydrzmdmh8raqt0k8qmuetsf"\ndao: 200.0 (CKB)\nfree: 16078049.27374609 (CKB)\nimmature: 8039369.55859429 (CKB)\ntotal: 16078249.27374609 (CKB)\n')),Object(s.b)("h3",{id:"list-dao-cells"},"List DAO Cells"),Object(s.b)("p",null,"The ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/c3bd18e6baac9c283995f25d226a689970dc9537/packages/common-scripts/src/dao.ts#L87"}),"dao.listDaoCells")," function can be used to list DAO cells for a specific type (deposit, withdraw or all). "),Object(s.b)("p",null,Object(s.b)("strong",{parentName:"p"},"Constructor")),Object(s.b)("p",null,Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/c3bd18e6baac9c283995f25d226a689970dc9537/packages/common-scripts/src/dao.ts#L87"}),"dao.listDaoCells"),'(cellProvider: CellProvider, fromAddress: string, cellType: "deposit" | "all" | "withdraw", { config }?: Options | undefined)'),Object(s.b)("p",null,"Example:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-typescript",metastring:'title="hellolumos/src/buildTXs.ts/listDAOCells()" {6}',title:'"hellolumos/src/buildTXs.ts/listDAOCells()"',"{6}":!0}),'export async function listDAOCells(\n    fromaddress: string,\n    celltype: "deposit" | "all" | "withdraw"\n) {\n    console.log("List the",celltype,"cells for the address", fromaddress);\n    for await (const cell of dao.listDaoCells(INDEXER,fromaddress,celltype)) {\n         console.log(cell); \n    }\n}\n')),Object(s.b)("p",null,"You can also use the collect function of the ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/c3bd18e6baac9c283995f25d226a689970dc9537/packages/common-scripts/src/dao.ts#L39"}),"dao.CellCollector")," class to list the DAO cells of a specific type."),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-typescript",metastring:"{5,10}","{5,10}":!0}),'export async function listDAOCells2(\n     fromInfo: FromInfo,\n     celltype: "deposit" | "all" | "withdraw"\n) {\n    const CellCollector = new dao.CellCollector(\n      fromInfo,\n      INDEXER,\n      celltype,\n    )\n    for await (const cell of CellCollector.collect()) {\n         console.log(cell); \n    }\n}\n')),Object(s.b)("p",null,"Try the ",Object(s.b)("inlineCode",{parentName:"p"},"listDAOCells")," function in the Node.js REPL mode:"),Object(s.b)("details",null,Object(s.b)("summary",null,"CLICK ME"),Object(s.b)("p",null,Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell"}),"$ cd hellolumos\n$ node --experimental-repl-await\nWelcome to Node.js v14.0.0.\nType \".help\" for more information.\n> const {accounts,buildTXs} = require(\".\");\nThe server is started.\n> const alice = accounts.ALICE;\n> await buildTXs.listDAOCells(alice.ADDRESS,\"deposit\");\nList the deposit cells for the address ckt1qyq8uqrxpw9tzg4u5waydrzmdmh8raqt0k8qmuetsf\n{\n  cell_output: {\n    capacity: '0x4a817c800',\n    lock: {\n      code_hash: '0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8',\n      hash_type: 'type',\n      args: '0x7e00660b8ab122bca3ba468c5b6eee71f40b7d8e'\n    },\n    type: {\n      code_hash: '0x82d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e',\n      hash_type: 'type',\n      args: '0x'\n    }\n  },\n  out_point: {\n    tx_hash: '0x58f49e100a00742396fa66bcd2541fadcae549b56e75350efaa166d5d5bfacdc',\n    index: '0x0'\n  },\n  block_hash: '0xc9a0077484dbcfa990e0d12b94d137723aec6a9f3ae44e8ed05e19084a076549',\n  block_number: '0x59',\n  data: '0x0000000000000000'\n}\n")))),Object(s.b)("h3",{id:"withdraw-a-cell-from-nervos-dao"},"Withdraw a Cell from Nervos DAO"),Object(s.b)("p",null,"Example: "),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-typescript",metastring:'title="hellolumos/src/buildTXs.ts/withdrawfromDAO()" {9}',title:'"hellolumos/src/buildTXs.ts/withdrawfromDAO()"',"{9}":!0}),'export async function withdrawfromDAO(\n    cell: Cell,\n    frominfo: string,\n    txFee: bigint,\n    privateKey:string\n):Promise<Hash> {\n    console.log("Withdraw a DAO cell for the address", frominfo);\n    let skeleton = TransactionSkeleton({ cellProvider: INDEXER });\n    skeleton = await dao.withdraw(skeleton, cell, frominfo);\n    skeleton = await secp256k1Blake160.payFee(skeleton, frominfo, BigInt(txFee));\n    skeleton = secp256k1Blake160.prepareSigningEntries(skeleton);\n    console.log("signingEntries:",skeleton.get("signingEntries").toArray());\n    const tx = await signandSeal(skeleton,privateKey);\n    //const rpc = new RPC("http://127.0.0.1:8114");\n    const hash = await rpc.send_transaction(tx);\n    console.log("The transaction hash is",hash);\n    return hash;\n}\n')),Object(s.b)("p",null,"The example creates a transaction skeleton and then uses the ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/c3bd18e6baac9c283995f25d226a689970dc9537/packages/common-scripts/src/dao.ts#L225"}),"dao.withdraw")," function to withdraw a deposited cell."),Object(s.b)("p",null,"The steps like adding transaction fee, preparing signing entries, signing and sealing the transaction, are the same as the previous examples. For more information, see the steps in the common transaction and the deposit transaction. "),Object(s.b)("p",null,"Try the ",Object(s.b)("inlineCode",{parentName:"p"},"withdrawfromDAO")," function in the Node.js REPL mode:"),Object(s.b)("details",null,Object(s.b)("summary",null,"CLICK ME"),Object(s.b)("p",null,Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell"}),"$ cd hellolumos\n$ node --experimental-repl-await\nWelcome to Node.js v14.0.0.\nType \".help\" for more information.\n> const {accounts,buildTXs} = require(\".\");\nThe server is started.\n> const alice = accounts.ALICE;\n//Choose one deposited cell from the result of the listDAOCells step.\n> const depositcell = {\n       cell_output: {\n         capacity: '0x4a817c800',\n         lock: {\n           code_hash: '0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8',\n           hash_type: 'type',\n           args: '0x7e00660b8ab122bca3ba468c5b6eee71f40b7d8e'\n         },\n         type: {\n           code_hash: '0x82d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e',\n           hash_type: 'type',\n           args: '0x'\n         }\n       },\n       out_point: {\n         tx_hash: '0x58f49e100a00742396fa66bcd2541fadcae549b56e75350efaa166d5d5bfacdc',\n         index: '0x0'\n       },\n       block_hash: '0xc9a0077484dbcfa990e0d12b94d137723aec6a9f3ae44e8ed05e19084a076549',\n       block_number: '0x59',\n       data: '0x0000000000000000'\n     };\n> await buildTXs.withdrawfromDAO(fullcell,alice.ADDRESS,10000000n,alice.PRIVATE_KEY);\nWithdraw a DAO cell for the address ckt1qyq8uqrxpw9tzg4u5waydrzmdmh8raqt0k8qmuetsf\nsigningEntries: [\n  {\n    type: 'witness_args_lock',\n    index: 0,\n    message: '0x7223a1da8032b346a69fc78957e144427e3c31c4c14afc2d87ed41635707df39'\n  }\n]\nThe transaction hash is 0x00df109343e2335a4e91375b37b575373902660be5f0d3fd0c2281b4425c1a7e\n'0x00df109343e2335a4e91375b37b575373902660be5f0d3fd0c2281b4425c1a7e'\n")))),Object(s.b)("h3",{id:"unlock-a-withdrawn-cell"},"Unlock a Withdrawn Cell"),Object(s.b)("p",null,"A withdrawn cell must be unlocked to make it usable as a live cell for new transactions."),Object(s.b)("div",{className:"admonition admonition-info alert alert--info"},Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-heading"}),Object(s.b)("h5",{parentName:"div"},Object(s.b)("span",Object(n.a)({parentName:"h5"},{className:"admonition-icon"}),Object(s.b)("svg",Object(n.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(s.b)("path",Object(n.a)({parentName:"svg"},{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})))),"info")),Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-content"}),Object(s.b)("p",{parentName:"div"},'A withdrawn cell can only be successfully unlocked when the epoch reaches the number that fulfills the lock period, i.e. the lock period of the cell has passed. Otherwise the unlock function will throw an error like "... the transaction is immature because of the since requirement...". '),Object(s.b)("p",{parentName:"div"},"The epoch number that fulfills the lock period = 180 (the default lock period) + ",Object(s.b)("var",null,"the epoch number of the deposit transaction")," + ",Object(s.b)("var",null,"the epoch index of the deposit transaction"),"/",Object(s.b)("var",null,"epoch length"),". "))),Object(s.b)("p",null,"Example: "),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-typescript",metastring:'title="hellolumos/src/buildTXs.ts/unlockWithdraw()"',title:'"hellolumos/src/buildTXs.ts/unlockWithdraw()"'}),'export async function unlockWithdraw(\n    depositinput: Cell,\n    withdrawinput: Cell,\n    toaddress:string,\n    frominfo: string,\n    txFee: bigint,\n    privateKey:string\n):Promise<Hash> {\n    let skeleton = TransactionSkeleton({ cellProvider: INDEXER });\n    skeleton = await dao.unlock(skeleton,depositinput,withdrawinput,toaddress,frominfo);\n    skeleton = await secp256k1Blake160.payFee(skeleton, frominfo, BigInt(txFee));\n    skeleton = secp256k1Blake160.prepareSigningEntries(skeleton);\n    console.log("signingEntries:",skeleton.get("signingEntries").toArray());\n    const tx = await signandSeal(skeleton,privateKey);\n    const hash = await rpc.send_transaction(tx);\n    console.log("The transaction hash is",hash);\n    return hash;\n}\n')),Object(s.b)("p",null,"The epoch information is located in the block header. The following commands gets the epoch information (0xa0009000008) of the deposit transaction. The epoch number that fulfills the lock period for the withdrawn cell is (180+8+9/10) . "),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell",metastring:"{8}","{8}":!0}),'> const {RPC}=require("@ckb-lumos/rpc");\n> const rpc = new RPC("http://127.0.0.1:8114");\n> const tx = await rpc.get_transaction("0x58f49e100a00742396fa66bcd2541fadcae549b56e75350efaa166d5d5bfacdc");\n> console.log(tx.tx_status.block_hash);\n0xc9a0077484dbcfa990e0d12b94d137723aec6a9f3ae44e8ed05e19084a076549\n> const block = await rpc.get_block("0xc9a0077484dbcfa990e0d12b94d137723aec6a9f3ae44e8ed05e19084a076549");\n> console.log(block.header.epoch);\n0xa0009000008 // {number: 8, index: 9, length: 10}\n')),Object(s.b)("p",null,"Try the ",Object(s.b)("inlineCode",{parentName:"p"},"unlockWithdraw")," function in the Node.js REPL mode."),Object(s.b)("details",null,Object(s.b)("summary",null,"CLICK ME"),Object(s.b)("p",null,Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell"}),"> await querytransactions.getTXStatus(\"0x00df109343e2335a4e91375b37b575373902660be5f0d3fd0c2281b4425c1a7e\"); // To check if the withdraw transaction is committed.\nThe transaction status is committed \n\n> await buildTXs.listDAOCells(alice.ADDRESS,\"withdraw\");\nList the withdraw cells for the address ckt1qyq8uqrxpw9tzg4u5waydrzmdmh8raqt0k8qmuetsf\n{\n  cell_output: {\n    capacity: '0x4a817c800',\n    lock: {\n      code_hash: '0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8',\n      hash_type: 'type',\n      args: '0x7e00660b8ab122bca3ba468c5b6eee71f40b7d8e'\n    },\n    type: {\n      code_hash: '0x82d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e',\n      hash_type: 'type',\n      args: '0x'\n    }\n  },\n  out_point: {\n    tx_hash: '0x00df109343e2335a4e91375b37b575373902660be5f0d3fd0c2281b4425c1a7e',\n    index: '0x0'\n  },\n  block_hash: '0x3d1589aa3a2fdaf2971a2528f5285b9755c983142f9eb42dcf27181711410d85',\n  block_number: '0x5f',\n  data: '0x5900000000000000'\n}\n> const withdrawcell = {\n  cell_output: {\n    capacity: '0x4a817c800',\n    lock: {\n      code_hash: '0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8',\n      hash_type: 'type',\n      args: '0x7e00660b8ab122bca3ba468c5b6eee71f40b7d8e'\n    },\n    type: {\n      code_hash: '0x82d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e',\n      hash_type: 'type',\n      args: '0x'\n    }\n  },\n  out_point: {\n    tx_hash: '0x00df109343e2335a4e91375b37b575373902660be5f0d3fd0c2281b4425c1a7e',\n    index: '0x0'\n  },\n  block_hash: '0x3d1589aa3a2fdaf2971a2528f5285b9755c983142f9eb42dcf27181711410d85',\n  block_number: '0x5f',\n  data: '0x5900000000000000'\n};\n> await buildTXs.unlockWithdraw(depositcell,withdrawcell,alice.ADDRESS, alice.ADDRESS,10000000n,alice.PRIVATE_KEY);\nsigningEntries: [\n  {\n    type: 'witness_args_lock',\n    index: 0,\n    message: '0xbc12c2f7123eb9c55addac3c93f22ad337e1cf6324c158b2ec8bd018755dd46f'\n  }\n]\nThe transaction hash is 0xe41b9a78b96719ac4e75eed1359d804e97812131ed961be0c33f27c6f254e08b\n'0xe41b9a78b96719ac4e75eed1359d804e97812131ed961be0c33f27c6f254e08b'\n")))),Object(s.b)("h3",{id:"transfer-ckb-with-locktimepool"},"Transfer CKB with locktimepool"),Object(s.b)("p",null,"Lumos provides ",Object(s.b)("a",Object(n.a)({parentName:"p"},{href:"https://github.com/nervosnetwork/lumos/blob/develop/packages/common-scripts/src/locktime_pool.ts"}),"locktimepool")," for the cells that has a lock period. "),Object(s.b)("div",{className:"admonition admonition-info alert alert--info"},Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-heading"}),Object(s.b)("h5",{parentName:"div"},Object(s.b)("span",Object(n.a)({parentName:"h5"},{className:"admonition-icon"}),Object(s.b)("svg",Object(n.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(s.b)("path",Object(n.a)({parentName:"svg"},{fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"})))),"info")),Object(s.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-content"}),Object(s.b)("p",{parentName:"div"},'The default lock period is 180 epochs. A cell that has a lock period is available for new transactions after the lock period of the cell passed. Otherwise transactions performed by the locktimepool.transfer function will throw an error like "Uncaught Error: Not enough capacity in from addresses!". '))),Object(s.b)("p",null,"Example:"),Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-typescript",metastring:'title="hellolumos/src/buildTXs.ts/locktimepoolTX()"',title:'"hellolumos/src/buildTXs.ts/locktimepoolTX()"'}),'import {locktimePool} from "@ckb-lumos/common-scripts";\n\nexport async function locktimepoolTX(\n    toaddress:string,\n    frominfo: string,\n    amount:bigint,\n    txFee:bigint,\n    privateKey:string\n):Promise<Hash> {\n    const tipheader = await rpc.get_tip_header();\n   \n    let skeleton = TransactionSkeleton({ cellProvider: INDEXER });\n    //@ts-ignore\n    skeleton = await locktimePool.transfer(skeleton, [frominfo], toaddress, BigInt(amount),tipheader);\n    console.log(JSON.stringify(createTransactionFromSkeleton(skeleton), null, 2));\n    skeleton = await locktimePool.payFee(skeleton,[frominfo], txFee, tipheader);\n    skeleton = locktimePool.prepareSigningEntries(skeleton);\n    skeleton.get("signingEntries").toArray();\n    const tx = await signandSeal(skeleton,privateKey);\n    const hash = await rpc.send_transaction(tx);\n    console.log("The transaction hash is",hash);\n    return hash;\n}\n')),Object(s.b)("p",null,"Try the ",Object(s.b)("inlineCode",{parentName:"p"},"locktimepoolTX")," function in the Node.js REPL mode:"),Object(s.b)("details",null,Object(s.b)("summary",null,"CLICK ME"),Object(s.b)("p",null,Object(s.b)("pre",null,Object(s.b)("code",Object(n.a)({parentName:"pre"},{className:"language-shell",metastring:"{77-102}","{77-102}":!0}),"$ node --experimental-repl-await\nWelcome to Node.js v14.0.0.\nType \".help\" for more information.\n> const { accounts,querytransactions, buildTXs}=require(\".\");\nThe server is started.\n>\n//Perform another deposit action to create a deposit cell \n> await buildTXs.deposit2DAO(alice.ADDRESS,20000000000n,10000000n,alice.PRIVATE_KEY);\n...\nThe transaction hash is 0x3162e8ccef8844e83c6cc63122f332f89d7dbd65c7d5f9fa040f4dd532b7abee\n> await querytransactions.getTXbyHash(\"0x3162e8ccef8844e83c6cc63122f332f89d7dbd65c7d5f9fa040f4dd532b7abee\");\nThe transaction status is committed\nThe block hash for the transaction is 0xd025028f2bc4e4381c0fb1743ada5a5c48e387bf6a49e162120ea9a626fe0772\n>\n> await buildTXs.listDAOCells(alice.ADDRESS,\"deposit\");\nList the deposit cells for the address ckt1qyq8uqrxpw9tzg4u5waydrzmdmh8raqt0k8qmuetsf\n{\n  cell_output: {\n    capacity: '0x4a817c800',\n    lock: {\n      code_hash: '0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8',\n      hash_type: 'type',\n      args: '0x7e00660b8ab122bca3ba468c5b6eee71f40b7d8e'\n    },\n    type: {\n      code_hash: '0x82d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e',\n      hash_type: 'type',\n      args: '0x'\n    }\n  },\n  out_point: {\n    tx_hash: '0x3162e8ccef8844e83c6cc63122f332f89d7dbd65c7d5f9fa040f4dd532b7abee',\n    index: '0x0'\n  },\n  block_hash: '0xd025028f2bc4e4381c0fb1743ada5a5c48e387bf6a49e162120ea9a626fe0772',\n  block_number: '0xf0e',\n  data: '0x0000000000000000'\n}\n>\n>const depositcell = {\n  cell_output: {\n    capacity: '0x4a817c800',\n    lock: {\n      code_hash: '0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8',\n      hash_type: 'type',\n      args: '0x7e00660b8ab122bca3ba468c5b6eee71f40b7d8e'\n    },\n    type: {\n      code_hash: '0x82d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e',\n      hash_type: 'type',\n      args: '0x'\n    }\n  },\n  out_point: {\n    tx_hash: '0x3162e8ccef8844e83c6cc63122f332f89d7dbd65c7d5f9fa040f4dd532b7abee',\n    index: '0x0'\n  },\n  block_hash: '0xd025028f2bc4e4381c0fb1743ada5a5c48e387bf6a49e162120ea9a626fe0772',\n  block_number: '0xf0e',\n  data: '0x0000000000000000'\n};\n>\n>\n//Withdraw the cell from DAO to prepare a withdraw cell that has a lock period.\n> await buildTXs.withdrawfromDAO(depositcell,alice.ADDRESS,10000000n,alice.PRIVATE_KEY);\n...\nThe transaction hash is 0xee510df9a3bebbb00eef405318ba4fa19e5112139a3718ff13921bb962f9dda0\n'0xee510df9a3bebbb00eef405318ba4fa19e5112139a3718ff13921bb962f9dda0'\n>\n//Check the withdraw transaction status.\n> await querytransactions.getTXbyHash(\"0xee510df9a3bebbb00eef405318ba4fa19e5112139a3718ff13921bb962f9dda0\");\nThe transaction status is committed\nThe block hash for the transaction is 0x63afdb21e9ce8173eb84bd59ac519aa80ab6f18cd4c61be9ceb5d536116c7a3f\n>\n//Check the cell in locktimepool, we can see the withdrawn cell in the locktime pool.\n> await querycells.locktimepoolCells(alice.ADDRESS);\n{\n  cell_output: {\n    capacity: '0x4a81c0719',\n    lock: {\n      code_hash: '0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8',\n      hash_type: 'type',\n      args: '0x7e00660b8ab122bca3ba468c5b6eee71f40b7d8e'\n    },\n    type: {\n      code_hash: '0x82d76d1b75fe2fd9a27dfbaa65a039221a380d76c926f378d3f81cf3e7e13f2e',\n      hash_type: 'type',\n      args: '0x'\n    }\n  },\n  out_point: {\n    tx_hash: '0xee510df9a3bebbb00eef405318ba4fa19e5112139a3718ff13921bb962f9dda0',\n    index: '0x0'\n  },\n  block_hash: '0x63afdb21e9ce8173eb84bd59ac519aa80ab6f18cd4c61be9ceb5d536116c7a3f',\n  block_number: '0xf1e',\n  data: '0x0e0f000000000000',\n  since: '0x20000a0004000235',\n  depositBlockHash: '0xd025028f2bc4e4381c0fb1743ada5a5c48e387bf6a49e162120ea9a626fe0772',\n  withdrawBlockHash: '0x63afdb21e9ce8173eb84bd59ac519aa80ab6f18cd4c61be9ceb5d536116c7a3f',\n  sinceValidationInfo: undefined\n}\n>\n>\n//when the epoch reaches '0x20000a0004000235'(565+4/10), the locktimepool.transfer function can be executed sucessfully.\n> await buildTXs.locktimepoolTX(bob.ADDRESS,alice.ADDRESS, 10000000000n,10000000n,alice.PRIVATE_KEY);\n")))))}b.isMDXComponent=!0},120:function(e,t,a){"use strict";a.d(t,"a",(function(){return d})),a.d(t,"b",(function(){return m}));var n=a(0),c=a.n(n);function s(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){s(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,c=function(e,t){if(null==e)return{};var a,n,c={},s=Object.keys(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||(c[a]=e[a]);return c}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(n=0;n<s.length;n++)a=s[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(c[a]=e[a])}return c}var l=c.a.createContext({}),b=function(e){var t=c.a.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},d=function(e){var t=b(e.components);return c.a.createElement(l.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return c.a.createElement(c.a.Fragment,{},t)}},h=c.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,s=e.originalType,o=e.parentName,l=i(e,["components","mdxType","originalType","parentName"]),d=b(a),h=n,m=d["".concat(o,".").concat(h)]||d[h]||p[h]||s;return a?c.a.createElement(m,r(r({ref:t},l),{},{components:a})):c.a.createElement(m,r({ref:t},l))}));function m(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var s=a.length,o=new Array(s);o[0]=h;var r={};for(var i in t)hasOwnProperty.call(t,i)&&(r[i]=t[i]);r.originalType=e,r.mdxType="string"==typeof e?e:n,o[1]=r;for(var l=2;l<s;l++)o[l]=a[l];return c.a.createElement.apply(null,o)}return c.a.createElement.apply(null,a)}h.displayName="MDXCreateElement"}}]);