(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{113:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return r})),n.d(t,"toc",(function(){return i})),n.d(t,"default",(function(){return u}));var c=n(3),l=n(7),a=(n(0),n(126)),o={id:"operateoncells",title:"Operate on Cells"},r={unversionedId:"tutorials/operateoncells",id:"tutorials/operateoncells",isDocsHomePage:!1,title:"Operate on Cells",description:"Prerequisites",source:"@site/docs\\tutorials\\operateOnCells.md",slug:"/tutorials/operateoncells",permalink:"/lumos_doc/docs/tutorials/operateoncells",editUrl:"https://github.com/xying21/lumos_doc/tree/master/docs/tutorials/operateOnCells.md",version:"current",lastUpdatedAt:1619535711,sidebar:"sidebar2",previous:{title:"Query on Cells",permalink:"/lumos_doc/docs/tutorials/querycells"},next:{title:"Query on Transactions",permalink:"/lumos_doc/docs/tutorials/querytransactions"}},i=[{value:"Prerequisites",id:"prerequisites",children:[]},{value:"Environment",id:"environment",children:[]},{value:"Examples",id:"examples",children:[{value:"Get the Cell Minimal Capacity",id:"get-the-cell-minimal-capacity",children:[]},{value:"Get the Balance of an Account",id:"get-the-balance-of-an-account",children:[]},{value:"Get the SUDT Balance of an Account",id:"get-the-sudt-balance-of-an-account",children:[]},{value:"Find Cells for Sufficient Capacity",id:"find-cells-for-sufficient-capacity",children:[]}]}],s={toc:i};function u(e){var t=e.components,n=Object(l.a)(e,["components"]);return Object(a.b)("wrapper",Object(c.a)({},s,n,{components:t,mdxType:"MDXLayout"}),Object(a.b)("h2",{id:"prerequisites"},"Prerequisites"),Object(a.b)("p",null,"The following prerequisites apply for the examples of this guide:"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},"The development environment is set up. For more information, see ",Object(a.b)("a",{parentName:"li",href:"http://localhost:3000/lumos_doc/docs/preparation/setupsystem"},"Set Up the Development Environment"),"."),Object(a.b)("li",{parentName:"ul"},"The CKB node is installed and started. For more information, see ",Object(a.b)("a",{parentName:"li",href:"http://localhost:3000/lumos_doc/docs/preparation/installckb"},"Install a CKB Node"),"."),Object(a.b)("li",{parentName:"ul"},"The Lumos packages (",Object(a.b)("inlineCode",{parentName:"li"},"@ckb-lumos/base"),", ",Object(a.b)("inlineCode",{parentName:"li"},"@ckb-lumos/indexer"),", ",Object(a.b)("inlineCode",{parentName:"li"},"@ckb-lumos/helpers"),") are installed.")),Object(a.b)("h2",{id:"environment"},"Environment"),Object(a.b)("p",null,"The following examples are verified on Ubuntu 20.04.2. Steps on the other platforms can be adjusted accordingly."),Object(a.b)("h2",{id:"examples"},"Examples"),Object(a.b)("h3",{id:"get-the-cell-minimal-capacity"},"Get the Cell Minimal Capacity"),Object(a.b)("p",null,"The three fields of a CKB cell and the cell itself all take up CKB capacity. The cell must have the capacity that is equal to or more than the total size of information stored in the cell. For more information, see ",Object(a.b)("a",{parentName:"p",href:"https://nervosnetwork.github.io/docs-new/docs/reference/cell"},"Nervos Docs: Cell"),"."),Object(a.b)("p",null,"For example, the minimum CKB capacity requirement is 61 CKB (6,100,000,000 shannons) for a common transaction, and 102 CKB (10,200,000,000 shannons) for a DAO deposit transaction."),Object(a.b)("p",null,"The ",Object(a.b)("a",{parentName:"p",href:"https://nervosnetwork.github.io/lumos/modules/helpers.html#minimalcellcapacity"},"minimalCellCapacity")," function of the ",Object(a.b)("inlineCode",{parentName:"p"},"@ckb-lumos/helpers")," package can be used to get the minimal capacity for a cell."),Object(a.b)("p",null,"Example:"),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-typescript",metastring:'title="hellolumos/src/querycells.ts/getMinimalCellCapacity" {4}',title:'"hellolumos/src/querycells.ts/getMinimalCellCapacity"',"{4}":!0},'import { minimalCellCapacity } from "@ckb-lumos/helpers";\n\nexport async function getMinimalCellCapacity(fullcell: Cell) {\n  const result = minimalCellCapacity(fullcell);\n  console.log("The minimal cell capacity is", result);\n}\n')),Object(a.b)("p",null,"Try the ",Object(a.b)("inlineCode",{parentName:"p"},"getMinimalCellCapacity")," function in the Node.js REPL mode:"),Object(a.b)("details",null,Object(a.b)("summary",null,"CLICK ME"),Object(a.b)("p",null,Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-shell",metastring:"{1,2,5,7-25}","{1,2,5,7-25}":!0},"$ cd hellolumos\n$ node --experimental-repl-await\nWelcome to Node.js v14.0.0.\nType \".help\" for more information.\n> const { querycells } = require(\".\");\nThe server is started.\n> const cell = {\n  cell_output: {\n    capacity: '0x1247656167b4',\n    lock: {\n      code_hash: '0x9bd7e06f3ecf4be0f2fcd2188b23f1b9fcc88e5d4b65a8637b17723bbda3cce8',\n      hash_type: 'type',\n      args: '0x7e00660b8ab122bca3ba468c5b6eee71f40b7d8e'\n    },\n    type: undefined\n  },\n  out_point: {\n    tx_hash: '0xdcd898c29a2d9dcbaca6c5112bb681d55acb5a557aaf2cbaa1ea2fe561ba3b36',\n    index: '0x0'\n  },\n  block_hash: '0x8030e31e760905f4e2c220f45b653ed73d0bdea5962bd34ca96bc3ea50cbc725',\n  block_number: '0x9a',\n  data: '0x'\n}\n> await querycells.getMinimalCellCapacity(cell);\nThe minimal cell capacity is 6100000000n\n")))),Object(a.b)("h3",{id:"get-the-balance-of-an-account"},"Get the Balance of an Account"),Object(a.b)("p",null,"The balance of an account means the total CKB capacity of the account. For more information, see ",Object(a.b)("a",{parentName:"p",href:"../preparation/createaccount#ckb-capacity-of-an-account"},"CKB Capacity of an Account"),"."),Object(a.b)("p",null,"The following example gathers the live (unspent) cells for a specific lock script (the lock script is the ID of an account) and then calculates the total capacity as the balance of the account. "),Object(a.b)("p",null,"Example:"),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-typescript",metastring:'title="hellolumos/src/querycells.ts/getBalancebyLock"',title:'"hellolumos/src/querycells.ts/getBalancebyLock"'},'import { INDEXER } from "./index";\nimport { Cell, Script } from "@ckb-lumos/base";\n\nexport async function getBalancebyLock(lockScript: Script) {\n  let balance = BigInt(0);\n  const collector = INDEXER.collector({ lock: lockScript });\n  const cells: Cell[] = [];\n  for await (const cell of collector.collect()) {\n    cells.push(cell);\n  }\n  balance = cells\n    .map((cell) => BigInt(cell.cell_output.capacity))\n    .reduce((balance, capacity) => (balance = balance += capacity), BigInt(0));\n  console.log("The balance of the account is", balance);\n}\n')),Object(a.b)("p",null,"Try the ",Object(a.b)("inlineCode",{parentName:"p"},"GetBalancebyLock")," function in the Node.js REPL mode:"),Object(a.b)("details",null,Object(a.b)("summary",null,"CLICK ME"),Object(a.b)("p",null,Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-shell",metastring:"{1,2,5,7-10}","{1,2,5,7-10}":!0},'$ cd hellolumos\n$ node --experimental-repl-await\nWelcome to Node.js v14.0.0.\nType ".help" for more information.\n> const { accounts, querycells } = require(".");\nThe server is started.\n> const alice = accounts.ALICE;\n> const { parseAddress } = require("@ckb-lumos/helpers");\n> const script = parseAddress(alice.ADDRESS);\n> await querycells.getBalancebyLock(script);\nThe balance of the account is 522545522203302n\n')))),Object(a.b)("h3",{id:"get-the-sudt-balance-of-an-account"},"Get the SUDT Balance of an Account"),Object(a.b)("p",null,"The following example collects the cells for a lock script and a SUDT script, and then calculates the total amount of SUDT tokens for the account. "),Object(a.b)("p",null,"Example:"),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-typescript",metastring:'title="hellolumos/src/querycells.ts/getSUDTBalance"',title:'"hellolumos/src/querycells.ts/getSUDTBalance"'},'import { INDEXER } from "./index";\nimport { Cell, Script } from "@ckb-lumos/base";\n\nexport async function getSUDTBalance(lock: Script, sudtType: Script) {\n  let balance = BigInt(0);\n  const collector = INDEXER.collector({ lock, type: sudtType });\n  const cells: Cell[] = [];\n  for await (const cell of collector.collect()) {\n    cells.push(cell);\n  }\n\n  balance = cells\n    .map((cell) => utils.readBigUInt128LE(cell.data))\n    .reduce((balance, amount) => (balance = balance += amount), BigInt(0));\n  console.log("The SUDT balance of the account is", balance);\n}\n')),Object(a.b)("p",null,"For more information about SUDT and SUDT operations, see ",Object(a.b)("a",{parentName:"p",href:"../tutorials/buildtransactions#issue-sudt-tokens"},"Issue SUDT Tokens")," and ",Object(a.b)("a",{parentName:"p",href:"../tutorials/buildtransactions#transfer-sudt-tokens"},"Transfer SUDT Tokens"),"."),Object(a.b)("h3",{id:"find-cells-for-sufficient-capacity"},"Find Cells for Sufficient Capacity"),Object(a.b)("p",null,"The following example collects a set of cells that can provide sufficient CKB capacity."),Object(a.b)("p",null,"Example:"),Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-typescript",metastring:'title="hellolumos/src/querycells.ts/getBalancebyLock"',title:'"hellolumos/src/querycells.ts/getBalancebyLock"'},'import { INDEXER } from "./index";\nimport { Cell, Script } from "@ckb-lumos/base";\n\nexport const findCellsforSufficientAmount = async (\n  lockScript: Script,\n  amount: BigInt\n): Promise<Cell[]> => {\n  let foundCapacity = BigInt(0);\n  const Cells = [] as Cell[];\n\n  const collector = INDEXER.collector({ lock: lockScript });\n\n  const cells: Cell[] = [];\n  for await (const cell of collector.collect()) {\n    // If the cell has a type script or data, ignore\n    if (!cell.cell_output.type && cell.data === "0x") {\n      cells.push(cell);\n    }\n  }\n\n  for (const cell of cells) {\n    if (foundCapacity < amount) {\n      foundCapacity = foundCapacity + BigInt(cell.cell_output.capacity);\n      Cells.push(cell);\n    }\n    if (foundCapacity > amount) break;\n  }\n\n  if (foundCapacity < amount)\n    throw new Error(`Insufficient capacity cells found`);\n\n  return Cells;\n};\n')),Object(a.b)("p",null,"Try the ",Object(a.b)("inlineCode",{parentName:"p"},"findCellsforSufficientAmount")," function in the Node.js REPL mode:"),Object(a.b)("details",null,Object(a.b)("summary",null,"CLICK ME"),Object(a.b)("p",null,Object(a.b)("pre",null,Object(a.b)("code",{parentName:"pre",className:"language-shell",metastring:"{1,2,5,7-9,11,47}","{1,2,5,7-9,11,47}":!0},"$ cd hellolumos\n$ node --experimental-repl-await\nWelcome to Node.js v14.0.0.\nType \".help\" for more information.\n> const { accounts, querycells } = require(\".\");\nThe server is started.\n> const bob = accounts.BOB;\n> const { parseAddress } = require(\"@ckb-lumos/helpers\");\n> const script = parseAddress(bob.ADDRESS);\n//Take a look at the cells that Bob owns. Bob owns three cells, and each cell contain 200 CKB in the capacity field.\n> await querycells.findCellsbyLock(script);\nFind the cells by lock script:\n[\n  {\n    cell_output: { capacity: '0x4a817c800', lock: [Object], type: undefined },\n    out_point: {\n      tx_hash: '0x32a717c2af9160b800805796c68803213060df782834486c72cfbacbb0868d62',\n      index: '0x0'\n    },\n    block_hash: '0xc21b34b009d5e355357eb55d9ee3456c6a90632434cff8dc515b2f0a207f854c',\n    block_number: '0x15',\n    data: '0x'\n  },\n  {\n    cell_output: { capacity: '0x4a817c800', lock: [Object], type: undefined },\n    out_point: {\n      tx_hash: '0x144ae79bc6064ae99e51b7105f4b61328dd4293d68d132b7a04d86409952ae2e',\n      index: '0x0'\n    },\n    block_hash: '0x2d70e178be2447f784d9c8c1c52630d10b3b3b23575896e61ff15983a7e5ba59',\n    block_number: '0xc9',\n    data: '0x'\n  },\n  {\n    cell_output: { capacity: '0x4a817c800', lock: [Object], type: undefined },\n    out_point: {\n      tx_hash: '0x10104ec6857fd99b818e7b401216268c067ce7fbc536b77c86f3565c108e958e',\n      index: '0x0'\n    },\n    block_hash: '0x64623c86af1df458caac8a1433e50ae7ffc228aaa1975d60ed03dfe3ec4ca3fc',\n    block_number: '0xea',\n    data: '0x'\n  }\n]\n//Run the findCellsforSufficientAmount function to collect the cells that have a total\n//amount at least 300 CKB. The function returns two cells with the total amount of 400 CKB that is sufficient and more than 300 CKB.\n> await querycells.findCellsforSufficientAmount(script, 30000000000n);\n[\n  {\n    cell_output: { capacity: '0x4a817c800', lock: [Object], type: undefined },\n    out_point: {\n      tx_hash: '0x32a717c2af9160b800805796c68803213060df782834486c72cfbacbb0868d62',\n      index: '0x0'\n    },\n    block_hash: '0xc21b34b009d5e355357eb55d9ee3456c6a90632434cff8dc515b2f0a207f854c',\n    block_number: '0x15',\n    data: '0x'\n  },\n  {\n    cell_output: { capacity: '0x4a817c800', lock: [Object], type: undefined },\n    out_point: {\n      tx_hash: '0x144ae79bc6064ae99e51b7105f4b61328dd4293d68d132b7a04d86409952ae2e',\n      index: '0x0'\n    },\n    block_hash: '0x2d70e178be2447f784d9c8c1c52630d10b3b3b23575896e61ff15983a7e5ba59',\n    block_number: '0xc9',\n    data: '0x'\n  }\n]\n")))))}u.isMDXComponent=!0},126:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return f}));var c=n(0),l=n.n(c);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);t&&(c=c.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,c)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,c,l=function(e,t){if(null==e)return{};var n,c,l={},a=Object.keys(e);for(c=0;c<a.length;c++)n=a[c],t.indexOf(n)>=0||(l[n]=e[n]);return l}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(c=0;c<a.length;c++)n=a[c],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(l[n]=e[n])}return l}var s=l.a.createContext({}),u=function(e){var t=l.a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=u(e.components);return l.a.createElement(s.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return l.a.createElement(l.a.Fragment,{},t)}},d=l.a.forwardRef((function(e,t){var n=e.components,c=e.mdxType,a=e.originalType,o=e.parentName,s=i(e,["components","mdxType","originalType","parentName"]),p=u(n),d=c,f=p["".concat(o,".").concat(d)]||p[d]||b[d]||a;return n?l.a.createElement(f,r(r({ref:t},s),{},{components:n})):l.a.createElement(f,r({ref:t},s))}));function f(e,t){var n=arguments,c=t&&t.mdxType;if("string"==typeof e||c){var a=n.length,o=new Array(a);o[0]=d;var r={};for(var i in t)hasOwnProperty.call(t,i)&&(r[i]=t[i]);r.originalType=e,r.mdxType="string"==typeof e?e:c,o[1]=r;for(var s=2;s<a;s++)o[s]=n[s];return l.a.createElement.apply(null,o)}return l.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);